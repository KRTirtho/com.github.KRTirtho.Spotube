# yaml-language-server: $schema=https://raw.githubusercontent.com/flatpak/flatpak-builder/main/data/flatpak-manifest.schema.json
app-id: com.github.KRTirtho.Spotube
runtime: org.gnome.Platform
runtime-version: "48"
sdk: org.gnome.Sdk
command: spotube
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    version: '24.08'
    directory: lib/ffmpeg
    add-ld-path: .
cleanup-commands:
  - mkdir -p ${FLATPAK_DEST}/lib/ffmpeg
finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --share=network
  - --share=ipc
  - --device=dri
  - --filesystem=xdg-download
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.StatusNotifierWatcher
  - --system-talk-name=org.freedesktop.Avahi.*
  - --filesystem=xdg-documents
  - --filesystem=xdg-run/pipewire-0:ro
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  - --own-name=org.mpris.MediaPlayer2.spotube.*
modules:
  - shared-modules/libappindicator/libappindicator-gtk3-12.10.json
  - shared-modules/libsecret/libsecret.json
  - name: libnotify
    buildsystem: meson
    config-opts:
      - -Dtests=false
      - -Dintrospection=disabled
      - -Dgtk_doc=false
      - -Ddocbook_docs=disabled
    sources:
      - type: archive
        url: https://download.gnome.org/sources/libnotify/0.7/libnotify-0.7.8.tar.xz
        sha256: 69209e0b663776a00c7b6c0e560302a8dbf66b2551d55616304f240bba66e18c
  - name: yt-dlp
    no-autogen: true
    no-make-install: true
    make-args:
      - yt-dlp
      - PYTHON=/usr/bin/python3
    post-install:
      - install yt-dlp /app/bin
    sources:
      - type: archive
        url: "https://github.com/yt-dlp/yt-dlp/archive/refs/tags/2025.09.05.tar.gz"
        sha256: "ee27c601e60d703dc3e16f8d6306cbffd2a4dc801e3fa91d6323f496dd8a52ec"
  - name: jsoncpp
    buildsystem: meson
    config-opts:
      - --default-library=shared
    sources:
      - type: git
        url: https://github.com/open-source-parsers/jsoncpp
        tag: 1.9.5

  - name: libmpv
    cleanup:
      - /share/bash-completion
      - /share/zsh
      - /share/doc
      - /share/icons
      - /share/applications
    buildsystem: meson
    config-opts:
      - -Dlibmpv=true
      - -Dcplayer=false
      - -Dlua=disabled
      - -Ddebug=false
      - -Dbuild-date=false
      - -Dalsa=disabled
      - -Dmanpage-build=disabled
      - -Dvulkan=enabled
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.40.0.tar.gz
        sha256: 10a0f4654f62140a6dd4d380dcf0bbdbdcf6e697556863dc499c296182f081a3
        x-checker-data:
          type: anitya
          project-id: 5348
          stable-only: true
          url-template: https://github.com/mpv-player/mpv/archive/refs/tags/v$version.tar.gz
    modules:
      - name: libplacebo
        buildsystem: meson
        config-opts:
          - -Dopengl=enabled
          - -Dvulkan=enabled
          - -Dglslang=disabled
          - -Dd3d11=disabled
          - -Ddemos=False
        sources:
          - type: archive
            url: https://code.videolan.org/videolan/libplacebo/-/archive/v7.349.0/libplacebo-v7.349.0.tar.gz
            sha256: 79120e685a1836344b51b13b6a5661622486a84e4d4a35f6c8d01679a20fbc86
            x-checker-data:
              type: anitya
              project-id: 20101
              stable-only: true
              url-template: https://code.videolan.org/videolan/libplacebo/-/archive/v$version/libplacebo-v$version.tar.gz
          - type: archive
            url: https://github.com/pallets/jinja/archive/refs/tags/3.1.6.tar.gz
            sha256: 2074b22a72caa65474902234b320d73463d6d4c223ee49f4b433495758356337
            dest: 3rdparty/jinja
            x-checker-data:
              type: anitya
              project-id: 3894
              url-template: https://github.com/pallets/jinja/archive/refs/tags/$version.tar.gz
          - type: archive
            url: https://github.com/Dav1dde/glad/archive/refs/tags/v2.0.8.tar.gz
            sha256: 44f06f9195427c7017f5028d0894f57eb216b0a8f7c4eda7ce883732aeb2d0fc
            dest: 3rdparty/glad
            x-checker-data:
              type: anitya
              project-id: 300234
              url-template: https://github.com/Dav1dde/glad/archive/refs/tags/v$version.tar.gz

      - name: libass
        config-opts:
          - --disable-static
        sources:
          - type: archive
            url: https://github.com/libass/libass/releases/download/0.17.3/libass-0.17.3.tar.gz
            sha256: da7c348deb6fa6c24507afab2dee7545ba5dd5bbf90a137bfe9e738f7df68537
            x-checker-data:
              type: anitya
              project-id: 1560
              stable-only: true
              url-template: https://github.com/libass/libass/releases/download/$version/libass-$version.tar.gz

  - name: spotube
    buildsystem: simple
    build-commands:
      - sed -i 's|%{{APPDATA_RELEASE}}%|<release version="v5.0.0" date="2025-09-11"
        />|' spotube-src/linux/com.github.KRTirtho.Spotube.appdata.xml
      - install -Dm644 spotube-src/linux/com.github.KRTirtho.Spotube.appdata.xml /app/share/appdata/com.github.KRTirtho.Spotube.appdata.xml
      - desktop-file-edit spotube/spotube.desktop --set-key=Exec --set-value="spotube
        %u" --set-icon=com.github.KRTirtho.Spotube
      - install -Dm644 spotube/spotube-logo.png /app/share/icons/hicolor/128x128/apps/com.github.KRTirtho.Spotube.png
      - install -Dm644 spotube/spotube.desktop /app/share/applications/com.github.KRTirtho.Spotube.desktop
      - install -dm755 /app/bin /app/spotube
      - cp -R spotube/ /app
      - ln -s /app/spotube/spotube /app/bin/spotube
    sources:
      - type: archive
        dest: spotube
        url: https://github.com/KRTirtho/spotube/releases/download/v5.0.0/spotube-linux-5.0.0-x86_64.tar.xz
        sha256: 633244efd797f9a123db0e9848dd5242da1af06e2aaa2f85bdc84c687417457c
        only-arches:
          - x86_64
      - type: archive
        dest: spotube
        url: https://github.com/KRTirtho/spotube/releases/download/v5.0.0/spotube-linux-5.0.0-aarch64.tar.xz
        sha256: 2fc00737b87b096b3e4cb8a65dae43c43dad26069b9000e6bde806ef52adaa82
        only-arches:
          - aarch64
      - type: git
        dest: spotube-src
        url: https://github.com/KRTirtho/spotube
        tag: v5.0.0
